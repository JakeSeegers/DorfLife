<!DOCTYPE html>
<html>
<head>
    <title>DorfFriend - Modular Reproduction System Integration Example</title>
    
    <!-- Add module import for reproduction system -->
    <script type="module">
        import { createReproductionSystem } from './js/reproduction/systems/ReproductionSystem.js';
        
        // Make available globally for integration
        window.ReproductionSystem = { createReproductionSystem };
        
        // Optional: Run validation tests
        // import { runValidationTests } from './js/reproduction/tests/SystemValidation.js';
        // window.runTests = runValidationTests;
    </script>
</head>
<body>
    <!-- Your existing HTML content -->
    
    <script>
        // Example of modified game initialization
        
        // Your existing game object
        const game = {
            dwarfs: [],
            time: 0,
            gold: 100
            // ... other game properties
        };
        
        // INTEGRATION POINT 1: Initialize reproduction system
        function initGame() {
            // ... existing initialization code ...
            
            // Initialize modular reproduction system
            game.reproductionSystem = ReproductionSystem.createReproductionSystem({
                gameReference: game,
                debugMode: false  // Set to true for detailed logging
            });
            
            console.log('‚úÖ Modular reproduction system initialized');
            
            // ... rest of initialization ...
        }
        
        // INTEGRATION POINT 2: Modified Dwarf class
        class Dwarf {
            constructor(x, y, name, isAdult) {
                this.x = x || 100;
                this.y = y || 100;
                this.name = name || this.generateName();
                this.isAdult = isAdult !== false;
                this.gender = Math.random() < 0.5 ? 'male' : 'female';
                this.class = ['fighter', 'mage', 'archer'][Math.floor(Math.random() * 3)];
                
                // Basic needs
                this.hunger = 80 + Math.random() * 20;
                this.thirst = 80 + Math.random() * 20;
                this.rest = 70 + Math.random() * 30;
                this.joy = 60 + Math.random() * 40;
                this.coffee = 50 + Math.random() * 50;
                this.cleanliness = 70 + Math.random() * 30;
                
                // Personality traits (Big Five model)
                this.personality = {
                    openness: Math.random() * 100,
                    conscientiousness: Math.random() * 100,
                    extraversion: Math.random() * 100,
                    agreeableness: Math.random() * 100,
                    neuroticism: Math.random() * 100
                };
                
                // REMOVED: Old reproduction system initialization
                // this.reproductionStrategy = this.gender === 'male' ? 
                //     ['orange', 'blue', 'yellow'][Math.floor(Math.random() * 3)] : null;
                // this.territoryX = x;
                // this.territoryY = y;
                // this.guardedFemale = null;
                
                // Basic reproduction properties (will be initialized by system)
                this.isPregnant = false;
                this.pregnancyTimer = 0;
                this.maturityTimer = isAdult !== false ? 0 : Math.random() * 1800;
                this.reproductionCooldown = 0;
                this.mateSeekingTimer = 0;
                
                // Work and behavior
                this.task = 'idle';
                this.workTimer = 0;
                this.efficiency = 0.8 + Math.random() * 0.4;
                this.targetX = x;
                this.targetY = y;
                this.speed = 0.5 + Math.random() * 0.5;
                
                // Other properties...
                this.direction = Math.random() * Math.PI * 2;
                this.animPhase = Math.random() * Math.PI * 2;
                
                // ADDED: Initialize reproduction traits through modular system
                if (typeof game !== 'undefined' && game.reproductionSystem) {
                    game.reproductionSystem.initializeReproductionTraits(this);
                }
            }
            
            update() {
                // Age and maturity system
                if (!this.isAdult) {
                    this.maturityTimer++;
                    if (this.maturityTimer >= 1800) {
                        this.isAdult = true;
                        // Use existing addLog function
                        addLog(this.name + ' has reached maturity!', true);
                        
                        // Notify reproduction system
                        if (game.reproductionSystem) {
                            game.reproductionSystem.handleMaturity(this);
                        }
                    }
                }
                
                // REMOVED: Old pregnancy system
                // if (this.isPregnant) {
                //     this.pregnancyTimer++;
                //     if (this.pregnancyTimer >= 3600) {
                //         this.giveBirth();
                //     }
                // }
                
                // Cooldowns (keep for compatibility)
                if (this.reproductionCooldown > 0) this.reproductionCooldown--;
                if (this.mateSeekingTimer > 0) this.mateSeekingTimer--;
                
                // Needs decay
                if (game.time % 4 === 0) {
                    this.hunger = Math.max(0, this.hunger - 0.06);
                    this.thirst = Math.max(0, this.thirst - 0.08);
                    this.rest = Math.max(0, this.rest - 0.04);
                    this.joy = Math.max(0, this.joy - 0.03);
                    this.coffee = Math.max(0, this.coffee - 0.025);
                    this.cleanliness = Math.max(0, this.cleanliness - 0.035);
                }
                
                // Personality state updates (keep existing)
                this.updatePersonalityState();
                
                // MODIFIED: Reproduction behavior delegated to modular system
                if (this.isAdult && this.reproductionCooldown <= 0) {
                    if (game.reproductionSystem) {
                        game.reproductionSystem.updateReproductionBehavior(this);
                    }
                }
                
                this.executeTask();
                this.updateTask();
                this.move();

                if (this.workTimer > 0) this.workTimer--;
                this.animPhase += 0.1;
            }
            
            // Keep existing methods like generateName(), updatePersonalityState(), etc.
            generateName() {
                return DWARF_NAMES[Math.floor(Math.random() * DWARF_NAMES.length)] + '_' + Math.floor(Math.random() * 100);
            }
            
            // REMOVED: All old reproduction methods
            // updateReproductionBehavior() { /* removed */ }
            // seekMating() { /* removed */ }
            // establishTerritory() { /* removed */ }
            // guardFemale() { /* removed */ }
            // sneakyMating() { /* removed */ }
            // evaluateMales() { /* removed */ }
            // selectPreferredMale() { /* removed */ }
            // scoreMate() { /* removed */ }
            // attemptMating() { /* removed */ }
            // acceptMating() { /* removed */ }
            // giveBirth() { /* removed */ }
            
            // Keep other existing methods...
            distanceTo(other) {
                const dx = this.x - other.x;
                const dy = this.y - other.y;
                return Math.sqrt(dx * dx + dy * dy);
            }
            
            draw() {
                if (!ctx) return;
                
                ctx.save();
                
                // Existing drawing code...
                
                // Strategy indicator for adult males (UNCHANGED - works with modular system)
                if (this.isAdult && this.gender === 'male') {
                    const strategyColors = {
                        'orange': '#FF6600',
                        'blue': '#0066FF', 
                        'yellow': '#FFFF00'
                    };
                    ctx.fillStyle = strategyColors[this.reproductionStrategy];
                    ctx.beginPath();
                    ctx.arc(this.x + 10, this.y - 10, 3, 0, Math.PI * 2);
                    ctx.fill();
                }
                
                ctx.restore();
            }
            
            // Keep all other existing methods...
        }
        
        // INTEGRATION POINT 3: Modified game loop
        function gameLoop() {
            // Existing game loop code...
            
            // Update reproduction system (handles pregnancies and births)
            if (game.reproductionSystem) {
                game.reproductionSystem.updatePregnancies();
            }
            
            // Update each dwarf
            for (let dwarf of game.dwarfs) {
                dwarf.update();
            }
            
            // Existing rendering and other updates...
            
            game.time++;
        }
        
        // INTEGRATION POINT 4: Modified dwarf spawning
        function spawnDwarf(x, y, name, isAdult) {
            const dwarf = new Dwarf(x, y, name, isAdult);
            
            // Dwarf constructor already handles trait initialization
            game.dwarfs.push(dwarf);
            
            return dwarf;
        }
        
        // Example of debugging commands
        function setupDebugCommands() {
            // Enable debug mode
            window.enableReproductionDebug = function() {
                if (game.reproductionSystem) {
                    game.reproductionSystem.setDebugMode(true);
                    console.log('üêõ Reproduction debug mode enabled');
                }
            };
            
            // Get system statistics
            window.getReproductionStats = function() {
                if (game.reproductionSystem) {
                    return game.reproductionSystem.getStatistics();
                } else {
                    console.log('‚ùå Reproduction system not initialized');
                }
            };
            
            // Validate system
            window.validateReproductionSystem = function() {
                if (game.reproductionSystem) {
                    return game.reproductionSystem.validateSystem();
                } else {
                    console.log('‚ùå Reproduction system not initialized');
                }
            };
            
            // Force a birth (for testing)
            window.forceBirth = function(dwarfName) {
                const dwarf = game.dwarfs.find(d => d.name === dwarfName);
                if (dwarf && dwarf.isPregnant && game.reproductionSystem) {
                    game.reproductionSystem.pregnancyManager.forceBirth(dwarf);
                    console.log(`üçº Forced birth for ${dwarfName}`);
                } else {
                    console.log(`‚ùå Cannot force birth for ${dwarfName || 'undefined'}`);
                }
            };
            
            console.log('üîß Debug commands available:');
            console.log('  - enableReproductionDebug()');
            console.log('  - getReproductionStats()');
            console.log('  - validateReproductionSystem()');
            console.log('  - forceBirth(dwarfName)');
        }
        
        // Initialize everything
        document.addEventListener('DOMContentLoaded', function() {
            initGame();
            setupDebugCommands();
            
            // Start game loop
            setInterval(gameLoop, 50); // 20 FPS
            
            console.log('üéÆ Game initialized with modular reproduction system');
            console.log('üí° Try: getReproductionStats() in console for statistics');
        });
    </script>
</body>
</html>