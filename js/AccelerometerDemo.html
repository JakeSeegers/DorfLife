<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Accelerometer Demo</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .container {
            text-align: center;
            max-width: 600px;
            width: 100%;
        }
        
        .game-area {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 30px;
            margin: 20px 0;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .ball {
            width: 40px;
            height: 40px;
            background: #ff6b6b;
            border-radius: 50%;
            position: relative;
            margin: 20px auto;
            transition: transform 0.1s ease-out;
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.4);
        }
        
        .permission-button {
            display: none;
            background: #4ecdc4;
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 18px;
            border-radius: 25px;
            cursor: pointer;
            margin: 20px 0;
            box-shadow: 0 4px 15px rgba(78, 205, 196, 0.3);
            transition: all 0.3s ease;
        }
        
        .permission-button:hover {
            background: #45b7aa;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(78, 205, 196, 0.4);
        }
        
        .status {
            background: rgba(0, 0, 0, 0.2);
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            font-family: monospace;
            font-size: 14px;
            text-align: left;
        }
        
        .sensor-data {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        
        .data-panel {
            background: rgba(0, 0, 0, 0.2);
            padding: 15px;
            border-radius: 10px;
            font-family: monospace;
            font-size: 12px;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 3px solid white;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .hidden { display: none; }
        .visible { display: block; }
        
        .controls-info {
            background: rgba(255, 193, 7, 0.2);
            border: 2px solid rgba(255, 193, 7, 0.5);
            border-radius: 10px;
            padding: 15px;
            margin: 20px 0;
        }
        
        .touch-controls {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
            margin: 20px 0;
            max-width: 300px;
        }
        
        .touch-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 15px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .touch-btn:active {
            background: rgba(255, 255, 255, 0.4);
            transform: scale(0.95);
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Smart Accelerometer Demo</h1>
        
        <div class="game-area">
            <div id="loading-indicator">
                <div class="loading"></div>
                Detecting motion sensors...
            </div>
            
            <button id="permission-button" class="permission-button">
                üéÆ Enable Motion Controls
            </button>
            
            <div id="game-content" class="hidden">
                <h3>Tilt your device to move the ball!</h3>
                <div class="ball" id="ball"></div>
                
                <div class="sensor-data">
                    <div class="data-panel">
                        <h4>Motion Data</h4>
                        <div id="motion-data">No data</div>
                    </div>
                    <div class="data-panel">
                        <h4>Orientation Data</h4>
                        <div id="orientation-data">No data</div>
                    </div>
                </div>
            </div>
            
            <div id="fallback-controls" class="hidden">
                <div class="controls-info">
                    <h3>‚ö†Ô∏è Motion controls not available</h3>
                    <p>Use the buttons below to control the ball:</p>
                </div>
                
                <div class="touch-controls">
                    <button class="touch-btn" id="btn-up">‚Üë</button>
                    <button class="touch-btn" id="btn-up-right">‚Üó</button>
                    <button class="touch-btn" id="btn-right">‚Üí</button>
                    <button class="touch-btn" id="btn-left">‚Üê</button>
                    <button class="touch-btn" id="btn-center">‚åÇ</button>
                    <button class="touch-btn" id="btn-down-right">‚Üò</button>
                    <button class="touch-btn" id="btn-down-left">‚Üô</button>
                    <button class="touch-btn" id="btn-down">‚Üì</button>
                    <button class="touch-btn" id="btn-down-left2">‚Üô</button>
                </div>
            </div>
        </div>
        
        <div class="status" id="status">
            Initializing...
        </div>
    </div>

    <script type="module">
        import { SmartAccelerometer, SensorUtils } from './SmartAccelerometer.js';
        
        // DOM elements
        const loadingIndicator = document.getElementById('loading-indicator');
        const permissionButton = document.getElementById('permission-button');
        const gameContent = document.getElementById('game-content');
        const fallbackControls = document.getElementById('fallback-controls');
        const statusElement = document.getElementById('status');
        const ball = document.getElementById('ball');
        const motionDataElement = document.getElementById('motion-data');
        const orientationDataElement = document.getElementById('orientation-data');
        
        // Game state
        let ballX = 0;
        let ballY = 0;
        let smoothedTiltX = 0;
        let smoothedTiltY = 0;
        
        // Initialize accelerometer
        const accelerometer = new SmartAccelerometer();
        
        // Configuration
        const config = {
            onMotion: handleMotionData,
            onOrientation: handleOrientationData,
            onPermissionNeeded: showPermissionButton,
            onPermissionGranted: hidePermissionButton,
            onPermissionDenied: showFallbackControls,
            onReady: startGame,
            onFallback: showFallbackControls
        };
        
        // Initialize the system
        accelerometer.initialize(config);
        
        // Update status display
        setInterval(updateStatus, 500);
        
        function handleMotionData(data) {
            // Calculate tilt from acceleration data
            const tilt = SensorUtils.calculateTilt(data.accelerationIncludingGravity);
            
            // Smooth the input
            smoothedTiltX = SensorUtils.smooth(tilt.tiltX, smoothedTiltX, 0.8);
            smoothedTiltY = SensorUtils.smooth(tilt.tiltY, smoothedTiltY, 0.8);
            
            // Apply deadzone
            const tiltX = SensorUtils.applyDeadzone(smoothedTiltX / 90, 0.1);
            const tiltY = SensorUtils.applyDeadzone(smoothedTiltY / 90, 0.1);
            
            // Update ball position
            ballX += tiltX * 3;
            ballY += tiltY * 3;
            
            // Clamp to screen bounds
            ballX = Math.max(-100, Math.min(100, ballX));
            ballY = Math.max(-100, Math.min(100, ballY));
            
            // Update ball visual
            updateBallPosition();
            
            // Update motion data display
            motionDataElement.innerHTML = `
                Tilt X: ${tilt.tiltX.toFixed(1)}¬∞<br>
                Tilt Y: ${tilt.tiltY.toFixed(1)}¬∞<br>
                Smoothed X: ${smoothedTiltX.toFixed(1)}¬∞<br>
                Smoothed Y: ${smoothedTiltY.toFixed(1)}¬∞<br>
                Ball X: ${ballX.toFixed(1)}<br>
                Ball Y: ${ballY.toFixed(1)}
            `;
        }
        
        function handleOrientationData(data) {
            orientationDataElement.innerHTML = `
                Alpha: ${data.alpha?.toFixed(1) || 'null'}¬∞<br>
                Beta: ${data.beta?.toFixed(1) || 'null'}¬∞<br>
                Gamma: ${data.gamma?.toFixed(1) || 'null'}¬∞<br>
                Absolute: ${data.absolute || 'false'}
            `;
        }
        
        function showPermissionButton() {
            loadingIndicator.classList.add('hidden');
            permissionButton.classList.remove('hidden');
            permissionButton.style.display = 'block';
        }
        
        function hidePermissionButton() {
            permissionButton.classList.add('hidden');
            permissionButton.style.display = 'none';
        }
        
        function startGame() {
            loadingIndicator.classList.add('hidden');
            hidePermissionButton();
            gameContent.classList.remove('hidden');
            gameContent.classList.add('visible');
            
            console.log('Game started with motion controls');
        }
        
        function showFallbackControls() {
            loadingIndicator.classList.add('hidden');
            hidePermissionButton();
            gameContent.classList.add('hidden');
            fallbackControls.classList.remove('hidden');
            fallbackControls.classList.add('visible');
            
            setupTouchControls();
            console.log('Game started with fallback controls');
        }
        
        function setupTouchControls() {
            const buttons = {
                'btn-up': { x: 0, y: -5 },
                'btn-up-right': { x: 5, y: -5 },
                'btn-right': { x: 5, y: 0 },
                'btn-down-right': { x: 5, y: 5 },
                'btn-down': { x: 0, y: 5 },
                'btn-down-left': { x: -5, y: 5 },
                'btn-left': { x: -5, y: 0 },
                'btn-up-left': { x: -5, y: -5 },
                'btn-center': { x: 0, y: 0 }
            };
            
            Object.keys(buttons).forEach(buttonId => {
                const button = document.getElementById(buttonId);
                if (button) {
                    button.addEventListener('touchstart', (e) => {
                        e.preventDefault();
                        const movement = buttons[buttonId];
                        
                        if (buttonId === 'btn-center') {
                            ballX = 0;
                            ballY = 0;
                        } else {
                            ballX += movement.x;
                            ballY += movement.y;
                        }
                        
                        // Clamp to bounds
                        ballX = Math.max(-100, Math.min(100, ballX));
                        ballY = Math.max(-100, Math.min(100, ballY));
                        
                        updateBallPosition();
                    });
                    
                    button.addEventListener('click', (e) => {
                        e.preventDefault();
                        const movement = buttons[buttonId];
                        
                        if (buttonId === 'btn-center') {
                            ballX = 0;
                            ballY = 0;
                        } else {
                            ballX += movement.x;
                            ballY += movement.y;
                        }
                        
                        // Clamp to bounds
                        ballX = Math.max(-100, Math.min(100, ballX));
                        ballY = Math.max(-100, Math.min(100, ballY));
                        
                        updateBallPosition();
                    });
                }
            });
        }
        
        function updateBallPosition() {
            ball.style.transform = `translate(${ballX}px, ${ballY}px)`;
        }
        
        function updateStatus() {
            const status = accelerometer.getStatus();
            const data = accelerometer.getLatestData();
            
            statusElement.innerHTML = `
                <strong>System Status:</strong><br>
                Sensors Working: ${status.sensorsWorking ? '‚úÖ' : '‚ùå'}<br>
                Game Started: ${status.gameStarted ? '‚úÖ' : '‚ùå'}<br>
                Permission Requested: ${status.permissionRequested ? '‚úÖ' : '‚ùå'}<br>
                iOS Device: ${status.isIOS ? '‚úÖ' : '‚ùå'}<br>
                Requires Permission: ${status.requiresPermission ? '‚úÖ' : '‚ùå'}<br>
                Motion Data: ${status.hasMotionData ? '‚úÖ' : '‚ùå'}<br>
                Orientation Data: ${status.hasOrientationData ? '‚úÖ' : '‚ùå'}
            `;
        }
        
        // Permission button click handler
        permissionButton.addEventListener('click', async () => {
            console.log('Permission button clicked');
            permissionButton.disabled = true;
            permissionButton.textContent = 'Requesting permission...';
            
            try {
                await accelerometer.requestSensorPermission();
            } catch (error) {
                console.error('Error requesting permission:', error);
                showFallbackControls();
            }
            
            permissionButton.disabled = false;
            permissionButton.textContent = 'üéÆ Enable Motion Controls';
        });
        
        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            accelerometer.destroy();
        });
        
        // Make accelerometer globally available for debugging
        window.accelerometer = accelerometer;
        window.SensorUtils = SensorUtils;
        
        console.log('Smart Accelerometer Demo initialized');
        console.log('Debug: window.accelerometer and window.SensorUtils available');
    </script>
</body>
</html>